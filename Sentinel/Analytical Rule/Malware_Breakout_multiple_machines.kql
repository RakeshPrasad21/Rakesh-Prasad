//Malware Breakout Identified across multiple machines


// Define the threshold for breakout (e.g., malware detected on more than 3 devices in 1 hour)
let BreakoutThreshold = 0;
let TimeWindow = 1h; // Time window to identify malware breakout (adjust as needed)
DeviceEvents
| where ActionType == "AntivirusDetection" 
| extend DetectionType =parse_json(AdditionalFields)
| summarize CountMachines = dcount(DeviceName), InfectedMachines = make_set(DeviceName)
    by bin(TimeGenerated, TimeWindow), MalwareName = tostring(strcat(DetectionType.ThreatName, @"\", FileName))
| where CountMachines > BreakoutThreshold  // Malware detected on more than the threshold number of devices
| project TimeGenerated, MalwareName, CountMachines, InfectedMachines
| extend MalwareSpread = strcat("Malware ", MalwareName, " detected on ", tostring(CountMachines), " machines.")
| order by CountMachines desc
